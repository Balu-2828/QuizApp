<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Take Quiz</title>
  <link rel="stylesheet" href="style.css">

  <script>
    const token = localStorage.getItem('jwtToken');
    if (!token) {
      window.location.href = 'login.html';
    }
  </script>

</head>
<body>
<div class="container">
  <h2>Take Quiz</h2>
  <div id="quizFormContainer">
    <label>Category: <input type="text" id="quizCategory"></label>
    <label>Number of Questions: <input type="number" id="numQuestions" min="1"></label>
    <label>Title: <input type="text" id="quizTitle"></label>
    <button onclick="createQuiz()">Start Quiz</button>
  </div>

  <div id="quizContainer" style="display:none;">
    <h3 id="quizName"></h3>
    <div id="timer">Time: 00:00</div>
    <form id="quizForm"></form>
    <button type="button"  id="submitbtn" onclick="submitQuiz()">Submit Quiz</button>
    <div id="score"></div>
  </div>
</div>

<script>
  let quizId;
  let timeLeft; // 5 minutes
  let timerInterval;

  async function createQuiz() {
      const category = document.getElementById('quizCategory').value;
      const numQ = document.getElementById('numQuestions').value;
      const title = document.getElementById('quizTitle').value;
      const token = localStorage.getItem('jwtToken');

      const response = await fetch(`/quiz/create?category=${category}&numQ=${numQ}&title=${title}`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
      });
       if (!response.ok) {
            alert('Failed to create quiz. You may need to log in again.');
            return;
       }

      const newQuizId = await response.json();
      quizId = newQuizId;
      alert("Quiz Created successfully");
      loadQuizQuestions();
  }

  async function loadQuizQuestions() {
      const token = localStorage.getItem('jwtToken');
      const response = await fetch(`/quiz/get/${quizId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
      });

      if (!response.ok) {
            alert('Failed to load quiz questions.');
            return;
      }

      const questions = await response.json();


      // It calculates the total time: 30 seconds per question
        timeLeft = questions.length * 30;
        // ------------------------------------

      document.getElementById('quizFormContainer').style.display = 'none';
      document.getElementById('quizContainer').style.display = 'block';
      document.getElementById('quizName').innerText = "Quiz: " + document.getElementById('quizTitle').value;

      const form = document.getElementById('quizForm');
      form.innerHTML = '';

      questions.forEach((q, index) => {
          form.innerHTML += `
              <div class="question">
                  <p>${index + 1}. ${q.questionTitle}</p>
                  <label><input type="radio" name="q${q.id}" value="${q.option1}"> ${q.option1}</label><br>
                  <label><input type="radio" name="q${q.id}" value="${q.option2}"> ${q.option2}</label><br>
                  <label><input type="radio" name="q${q.id}" value="${q.option3}"> ${q.option3}</label><br>
                  <label><input type="radio" name="q${q.id}" value="${q.option4}"> ${q.option4}</label><br>
              </div>
              <hr>
          `;
      });

      startTimer();
  }

   function startTimer() {
        if (timerInterval) {
            clearInterval(timerInterval);
        }

        timerInterval = setInterval(() => {
            const minutes = Math.floor(timeLeft / 60).toString().padStart(2, '0');
            const seconds = (timeLeft % 60).toString().padStart(2, '0');
            document.getElementById('timer').innerText = `Time: ${minutes}:${seconds}`;
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                submitQuiz();
            }
            timeLeft--;
        }, 1000);
    }

  async function submitQuiz() {
      clearInterval(timerInterval);
      const form = document.getElementById('quizForm');
      const responses = [];
      const questions = form.querySelectorAll('.question');
      const token = localStorage.getItem('jwtToken');

      questions.forEach(qDiv => {
          const name = qDiv.querySelector('input[type=radio]').name;
          const selected = form.querySelector(`input[name=${name}]:checked`);
          if (selected) {
              responses.push({ id: parseInt(name.substring(1)), response: selected.value });
          } else {
              responses.push({ id: parseInt(name.substring(1)), response: "" });
          }
      });

      const res = await fetch(`/quiz/submit/${quizId}`, {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(responses)
      });

      const score = await res.json();
      document.getElementById('score').innerHTML = `
        <h3 style="color:green;">Your Score: ${score} / ${questions.length}</h3>
        <p>Percentage: ${((score/questions.length)*100).toFixed(2)}%</p>`;

      document.getElementById('submitbtn').style.display = 'none';
  }
</script>
</body>
</html>
